# Behavior: Opening a Document with Embedded Comments

behavior: "Document Loading and Display"
user_goal: "View a markdown document with all embedded comments parsed and displayed"
priority: critical

scenarios:
  - name: "Open valid document with comments"
    given:
      - "A markdown file exists at specified path"
      - "File contains valid CriticMarkup comments"
      - "File is readable by current user"
      - "File encoding is UTF-8"
    when:
      - "User executes open command with filepath"
    then:
      - "Document content is loaded into memory"
      - "All comment markers are identified and parsed"
      - "Document AST is constructed successfully"
      - "Comments are extracted into collection"
      - "Position map is created for all comments"
      - "Split-pane UI displays with document on left"
      - "Comment panel displays on right"
      - "Cursor positioned at document start"
      - "Status line shows document statistics"
      - "File is marked as unmodified"
    performance:
      - "Parse completes in < 500ms for 1MB file"
      - "UI renders in < 100ms after parse"
      - "Memory usage < 10x file size"

  - name: "Open document with malformed comments"
    given:
      - "A markdown file exists"
      - "File contains partially malformed comment syntax"
      - "Some comments are missing required metadata"
    when:
      - "User opens the document"
    then:
      - "Parser identifies malformed sections"
      - "Best-effort parsing extracts valid portions"
      - "Warning collection contains parse errors"
      - "Document displays with available comments"
      - "Warning indicator appears in status line"
      - "User can view parse error details"
      - "Malformed text preserved as-is in document"
      - "File integrity maintained"

  - name: "Open large document with many comments"
    given:
      - "Document size is 5MB"
      - "Document contains 1000+ comments"
      - "All comments are well-formed"
    when:
      - "User opens the document"
    then:
      - "Async parsing initiated"
      - "Progress indicator shown during parse"
      - "Comments incrementally available"
      - "UI remains responsive during load"
      - "Document displays when parse completes"
      - "Comment count shown accurately"
      - "Scroll performance remains smooth"
    performance:
      - "First render in < 2 seconds"
      - "Memory usage < 100MB"
      - "Smooth scrolling at 60fps"

  - name: "Open non-existent file"
    given:
      - "Specified filepath does not exist"
    when:
      - "User attempts to open the file"
    then:
      - "Error code FILE_NOT_FOUND returned"
      - "Clear error message displayed to user"
      - "No partial state created"
      - "UI returns to previous state or empty"
      - "Suggestion to create new file offered"

  - name: "Open file without read permissions"
    given:
      - "File exists at path"
      - "Current user lacks read permissions"
    when:
      - "User attempts to open the file"
    then:
      - "Error code PERMISSION_DENIED returned"
      - "Clear error message explains permission issue"
      - "No document state created"
      - "Suggestion to check permissions provided"

  - name: "Open document with nested comments"
    given:
      - "Document contains comments within comments"
      - "Maximum nesting depth is 3 levels"
    when:
      - "User opens the document"
    then:
      - "All comment levels are parsed correctly"
      - "Nesting relationships preserved"
      - "Thread hierarchy constructed"
      - "Visual indentation shows nesting"
      - "Each comment maintains correct position"

  - name: "Open document with Unicode content"
    given:
      - "Document contains multi-byte UTF-8 characters"
      - "Comments contain emoji and special characters"
      - "Mixed language content present"
    when:
      - "User opens the document"
    then:
      - "All characters display correctly"
      - "Position calculations account for byte length"
      - "Comment markers correctly identified"
      - "No character corruption occurs"
      - "Line/column positions accurate"

  - name: "Reopen previously opened document"
    given:
      - "Document was opened in previous session"
      - "Document has been modified since last open"
      - "Checksum differs from cached version"
    when:
      - "User reopens the document"
    then:
      - "Fresh parse of current file state"
      - "Cache invalidated and rebuilt"
      - "New checksum calculated"
      - "User positioned at last known location (if available)"
      - "Modified indicator reflects current state"

edge_cases:
  - name: "Empty file"
    condition: "File exists but contains no content"
    expected: "Opens successfully with empty document view"

  - name: "File with only comments"
    condition: "No regular markdown content, only comment markup"
    expected: "Comments extracted, document shows as blank content"

  - name: "Binary file incorrectly opened"
    condition: "User attempts to open non-text file"
    expected: "Detect binary content, refuse to open, show error"

  - name: "Extremely long lines"
    condition: "Document has lines exceeding 10,000 characters"
    expected: "Lines truncated for display, full content preserved"

  - name: "Mixed line endings"
    condition: "Document contains both CRLF and LF"
    expected: "Line endings normalized, positions calculated correctly"

invariants:
  - "Document content never modified during open operation"
  - "All valid comments always extracted"
  - "Parse errors never prevent document display"
  - "File state matches memory state after load"
  - "Position map always consistent with AST"

quality_attributes:
  usability:
    - "Clear progress indication for large files"
    - "Informative error messages"
    - "Graceful degradation on parse errors"

  reliability:
    - "Never corrupt file during read"
    - "Handle all text encodings properly"
    - "Recover from partial parse failures"

  performance:
    - "Responsive for files up to 10MB"
    - "Incremental display for very large files"
    - "Minimal memory footprint"
